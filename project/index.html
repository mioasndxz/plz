<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Ï†ïÎ¶¨ ÎèÑÏö∞ÎØ∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        }

        .screen {
            display: none; /* Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Î™®Îì† ÌôîÎ©¥ Ïà®ÍπÄ */
            width: 100%;
            max-width: 640px;
            margin: 16px auto;
            box-sizing: border-box;
            padding: 0 16px; /* Ï¢åÏö∞ Ïó¨Î∞± */
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #loadingScreen, #cameraScreen {
            padding-top: 50px; /* ÏÉÅÎã® Ïó¨Î∞± */
        }

        #loadingScreen p {
            font-size: 1.2em;
            font-weight: bold;
            color: #00796b;
            text-align: center;
        }

        #video-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 ÎπÑÏú® (480/640 = 0.75) */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #video, #liveCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ÎπÑÏú® Ïú†ÏßÄÌïòÎ©∞ Ï±ÑÏö∞Í∏∞ */
        }
        #liveCanvas {
            z-index: 10;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 1.05em;
            font-weight: 700;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            max-width: 250px;
        }
        button:hover {
            background: #357ABD;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .modal-overlay {
            display: none; /* Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïà®ÍπÄ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
        }

        h3 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 8px;
        }
        ul {
            list-style: none;
            padding-left: 0;
        }
        li {
            margin: 8px 0;
            display: flex;
            align-items: flex-start; /* Ï≤¥ÌÅ¨Î∞ïÏä§ÏôÄ ÌÖçÏä§Ìä∏ Ï†ïÎ†¨ */
            font-size: 0.95em;
        }
        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
            accent-color: #4a90e2;
            flex-shrink: 0; /* Ï≤¥ÌÅ¨Î∞ïÏä§Í∞Ä Ï§ÑÏñ¥Îì§ÏßÄ ÏïäÎèÑÎ°ù */
            margin-top: 4px; /* ÌÖçÏä§Ìä∏ Î≤†Ïù¥Ïä§ÎùºÏù∏Ïóê ÎßûÏ∂îÍ∏∞ */
        }
        .message-box {
            text-align: center;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .error { color: #d32f2f; font-weight: bold; text-align: center; margin-top: 15px; padding: 10px; background-color: #ffebee; border-radius: 8px; }
        .scoreBox, .tipsBox, .spaceBox {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            line-height: 1.5;
            background: #f8f8f8;
            padding: 12px;
            border-radius: 8px;
        }
        .scoreBox { color: #28a745; font-size: 1.3em; background: #e6ffe6; }
        .tipsBox { color: #007bff; background: #e8f5ff; }
        .spaceBox { color: #6f42c1; background: #f3e6ff; }

        .modal-img-container {
            width: 100%;
            position: relative;
            padding-top: 75%; /* 4:3 ÎπÑÏú® */
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #modalCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>

<div id="loadingScreen" class="screen active">
    <p>Î™®Îç∏ Î°úÎî© Ï§ë... Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.</p>
</div>

<div id="cameraScreen" class="screen">
    <div id="video-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="liveCanvas" width="640" height="480"></canvas>
    </div>

    <div class="button-group">
        <button id="analyzeBeforeBtn">üì∏ ÌòÑÏû¨ Í≥µÍ∞Ñ Î∂ÑÏÑù</button>
        <button id="analyzeAfterBtn" disabled>‚úÖ Ï†ïÎ¶¨ ÌõÑ Ï†êÏàò Îß§Í∏∞Í∏∞</button>
    </div>

    <p class="error" id="errorMessage"></p>
    <p id="analysisStatusMessage" style="text-align: center; color: #555; margin-top: 10px;"></p>
</div>

<div id="resultModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
        <h3 id="modalTitle"></h3>
        <div class="modal-img-container">
            <canvas id="modalCanvas" width="640" height="480"></canvas>
        </div>
        <div class="spaceBox" id="modalSpaceInfo"></div>
        <div class="tipsBox" id="modalTipsInfo"></div>
        <div class="scoreBox" id="modalScoreInfo"></div>
        <div id="modalChecklistInfo"></div>
        <p id="modalFeedbackMessage"></p>
        <button onclick="closeResultModal()">ÌôïÏù∏</button>
        <button id="resetAppBtn" style="background: #dc3545; display: none;" onclick="resetApplication()">Îã§Ïãú ÏãúÏûë</button>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script>
    const loadingScreen = document.getElementById("loadingScreen");
    const cameraScreen = document.getElementById("cameraScreen");
    const video = document.getElementById("video");
    const liveCanvas = document.getElementById("liveCanvas"); // Ïã§ÏãúÍ∞Ñ Î∞ïÏä§ Í∑∏Î¶¨Í∏∞Ïö©
    const liveCtx = liveCanvas.getContext("2d");
    const analyzeBeforeBtn = document.getElementById("analyzeBeforeBtn");
    const analyzeAfterBtn = document.getElementById("analyzeAfterBtn");
    const errorMessage = document.getElementById("errorMessage");
    const analysisStatusMessage = document.getElementById("analysisStatusMessage");

    const resultModalOverlay = document.getElementById("resultModalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalCanvas = document.getElementById("modalCanvas");
    const modalCtx = modalCanvas.getContext("2d");
    const modalSpaceInfo = document.getElementById("modalSpaceInfo");
    const modalTipsInfo = document.getElementById("modalTipsInfo");
    const modalScoreInfo = document.getElementById("modalScoreInfo");
    const modalChecklistInfo = document.getElementById("modalChecklistInfo");
    const modalFeedbackMessage = document.getElementById("modalFeedbackMessage");
    const resetAppBtn = document.getElementById("resetAppBtn");

    let cocoModel = null;
    let clutterModel = null; // Ïª§Ïä§ÌÖÄ Î™®Îç∏ Î≥ÄÏàò ÏÑ†Ïñ∏
    let customLabels = []; // label.txtÏóêÏÑú Î°úÎìúÌï† Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏î
    let beforeLabels = [];
    let beforeSnapshotData = null; // Ï†ïÎ¶¨ Ï†Ñ Ïä§ÎÉÖÏÉ∑ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÌòÑÏû¨ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå, ÌïÑÏöîÌïú Í≤ΩÏö∞ ÌôúÏö©)

    // label.txt ÌååÏùºÏùÑ Î°úÎìúÌïòÎäî Ìï®Ïàò
    async function loadLabels(path) {
        try {
            const response = await fetch(path);
            const text = await response.text();
            // 'names:' Ïù¥ÌõÑÏùò ÎùºÏù∏Îì§ÏùÑ ÌååÏã±
            const lines = text.split('\n');
            const startIndex = lines.findIndex(line => line.includes('names:')) + 1;
            const labels = [];
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const match = line.match(/^\d+:\s*(.*)/); // "570: Trombone" ÌòïÏãù ÌååÏã±
                    if (match && match[1]) {
                        labels.push(match[1].trim());
                    }
                }
            }
            return labels;
        } catch (error) {
            console.error("Error loading labels:", error);
            errorMessage.textContent = "‚ùó Î†àÏù¥Î∏î ÌååÏùºÏùÑ Î°úÎìúÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: " + error.message;
            return [];
        }
    }

    // COCO ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†ÅÏù∏ Ïù¥Î¶ÑÏúºÎ°ú Îß§ÌïëÌïòÍ≥†, ÌäπÏ†ï Í∞ùÏ≤¥ Í∑∏Î£πÌôî
    function mapLabelToFriendlyName(label) {
        const lowerLabel = label.toLowerCase();
        switch (lowerLabel) {
            case 'dining table': return 'Ï±ÖÏÉÅ';
            case 'couch': return 'ÏÜåÌåå';
            case 'potted plant': return 'ÌôîÎ∂Ñ';
            case 'refrigerator': return 'ÎÉâÏû•Í≥†';
            case 'bed': return 'Ïπ®ÎåÄ';
            case 'chair': return 'ÏùòÏûê';
            case 'book': return 'Ï±Ö';
            case 'cup': return 'Ïªµ';
            case 'bottle': return 'Î≥ë';
            case 'laptop': return 'ÎÖ∏Ìä∏Î∂Å';
            case 'backpack': return 'Í∞ÄÎ∞©';
            case 'handbag': return 'Í∞ÄÎ∞©'; // Í∞ÄÎ∞©Î•ò ÌÜµÌï©
            case 'cell phone': return 'Ìú¥ÎåÄÌè∞';
            case 'remote': return 'Î¶¨Î™®Ïª®';
            case 'keyboard': return 'ÌÇ§Î≥¥Îìú';
            case 'mouse': return 'ÎßàÏö∞Ïä§';
            case 'tv': return 'TV';
            case 'scissors': return 'Í∞ÄÏúÑ';
            case 'vase': return 'ÍΩÉÎ≥ë';
            case 'toilet': return 'Î≥ÄÍ∏∞'; // ÌôîÏû•Ïã§ Í≥µÍ∞Ñ Ïù∏ÏãùÏóê ÌôúÏö©
            case 'toothbrush': return 'Ïπ´ÏÜî'; // ÏöïÏã§ Ïö©Ìíà
            case 'clock': return 'ÏãúÍ≥Ñ';
            // TODO: Ï£ºÏù∏ÎãòÏùò Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ ÏÉàÎ°úÏö¥ Í∞ùÏ≤¥Î•º Í∞êÏßÄÌïúÎã§Î©¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
            // customLabels Î∞∞Ïó¥Ïóê Ìè¨Ìï®Îêú Î†àÏù¥Î∏îÏùÄ mapLabelToFriendlyName Ìï®ÏàòÎ•º ÌÜµÍ≥ºÌïòÏó¨ Í∑∏ÎåÄÎ°ú Î∞òÌôòÎêòÎØÄÎ°ú
            // Ïù¥ switch Î¨∏Ïóê Ï∂îÍ∞ÄÌï† ÌïÑÏöîÎäî ÏóÜÏßÄÎßå, ÌäπÎ≥ÑÌûà Ïù¥Î¶ÑÏùÑ Î≥ÄÍ≤ΩÌïòÍ≥† Ïã∂Îã§Î©¥ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.
            // Ïòà: case 'cosmetics': return 'ÌôîÏû•Ìíà';
            default:
                // customLabelsÏóêÏÑú Ï∞æÏïÑÏÑú Î∞òÌôò (ÎßåÏïΩ COCO Î™®Îç∏Ïù¥ ÏïÑÎãå Ïª§Ïä§ÌÖÄ Î™®Îç∏ Î†àÏù¥Î∏îÏù¥ÎùºÎ©¥)
                if (customLabels.includes(label)) {
                    return label; // Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏îÏùÄ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                }
                return lowerLabel; // Îß§ÌïëÎêòÏßÄ ÏïäÏùÄ Í≤ÉÏùÄ ÏõêÎûò Ïù¥Î¶Ñ Î∞òÌôò (ÏÜåÎ¨∏ÏûêÎ°ú)
        }
    }

    const tipDictionary = {
        Ï±Ö: "üìö Ï±ÖÏùÄ Ï±ÖÍΩÇÏù¥ÎÇò ÏÑ†Î∞òÏóê Ï†ïÎ¶¨Ìï¥ Ï£ºÏÑ∏Ïöî.",
        Ïªµ: "‚òï ÏªµÏùÄ ÏîªÏñ¥ÏÑú Í±¥Ï°∞ÎåÄÏóê ÎÜìÍ±∞ÎÇò ÏàòÎÇ©ÌïòÏÑ∏Ïöî.",
        Î≥ë: "üß¥ Î≥ëÏùÄ ÎÇ¥Ïö©Î¨ºÏùÑ ÎπÑÏö∞Í≥† Î∂ÑÎ¶¨ÏàòÍ±∞ÌïòÍ±∞ÎÇò Ï†úÏûêÎ¶¨Ïóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        ÎÖ∏Ìä∏Î∂Å: "üíª ÎÖ∏Ìä∏Î∂ÅÏùÄ ÏÇ¨Ïö© ÌõÑ Îã´ÏïÑÏÑú Ï†ïÌï¥ÏßÑ ÏúÑÏπòÏóê ÎÜìÏúºÏÑ∏Ïöî.",
        ÏùòÏûê: "ü™ë ÏùòÏûêÎäî ÏÇ¨Ïö© ÌõÑ Ï±ÖÏÉÅ ÏïÑÎûòÎ°ú Î∞ÄÏñ¥ ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.",
        Í∞ÄÎ∞©: "üéí Í∞ÄÎ∞©ÏùÄ ÎÇ¥Ïö©Î¨ºÏùÑ ÎπÑÏö∞Í≥† Ï†úÏûêÎ¶¨Ïóê Í±∏Ïñ¥ÎëêÏÑ∏Ïöî.",
        Ìú¥ÎåÄÌè∞: "üì± Ìú¥ÎåÄÌè∞ÏùÄ Ï∂©Ï†Ñ ÏúÑÏπòÎÇò Ï†ÑÏö© Í±∞ÏπòÎåÄÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        Î¶¨Î™®Ïª®: "üïπÔ∏è Î¶¨Î™®Ïª®ÏùÄ Ï†úÏûêÎ¶¨Ïóê ÎëêÍ±∞ÎÇò ÏàòÎÇ©Ìï®Ïóê ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.",
        ÌÇ§Î≥¥Îìú: "‚å®Ô∏è ÏÇ¨Ïö© ÌõÑÏóêÎäî Ï†ú ÏúÑÏπòÏóê ÎëêÍ±∞ÎÇò Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî.",
        ÎßàÏö∞Ïä§: "üñ±Ô∏è ÏÇ¨Ïö© ÌõÑÏóêÎäî Ï†ú ÏúÑÏπòÏóê ÎëêÍ±∞ÎÇò Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî.",
        Ïπ´ÏÜî: "ü™• Ïπ´ÏÜîÏùÄ ÏÇ¨Ïö© ÌõÑ Ïπ´ÏÜîÍΩÇÏù¥Ïóê Ï†úÎåÄÎ°ú Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        // TODO: Ï£ºÏù∏ÎãòÏùò Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ Í∞êÏßÄÌïòÎäî ÏÉàÎ°úÏö¥ Î¨ºÍ±¥Ïóê ÎåÄÌïú ÌåÅÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
        // Ïòà: 'ÌôîÏû•Ìíà': "üíÑ ÌôîÏû•ÌíàÏùÄ ÌôîÏû•ÎåÄÏóê Ï†ïÎèàÌïòÍ±∞ÎÇò ÏÑúÎûçÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        // Ïòà: 'Ï≤≠ÏÜåÏö©Ìíà': "üß∫ Ï≤≠ÏÜåÏö©ÌíàÏùÄ Ï†ÑÏö© ÏàòÎÇ©Í≥µÍ∞ÑÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî."
    };

    const checklistDictionary = {
        Ï±Ö: ["Ï±ÖÍΩÇÏù¥Ïóê ÎÑ£Í∏∞", "ÏùΩÏßÄ ÏïäÎäî Ï±Ö Î∂ÑÎ•ò"],
        Ïªµ: ["Ïªµ ÏîªÍ∏∞", "Í±¥Ï°∞ÎåÄÏóê ÎÜìÍ∏∞", "ÏàòÎÇ©ÌïòÍ∏∞"],
        Î≥ë: ["ÎöúÍªë Îã´Í∏∞", "Ïû¨ÌôúÏö©Ìï®Ïóê ÎÑ£Í∏∞", "ÎÇ¥Ïö©Î¨º ÎπÑÏö∞Í∏∞"],
        ÎÖ∏Ìä∏Î∂Å: ["ÎçÆÍ∞ú Îã´Í∏∞", "Ï∂©Ï†ÑÍ∏∞ Ï†ïÎ¶¨", "Ï†ÑÏõê ÎÅÑÍ∏∞"],
        ÏùòÏûê: ["Ï†ïÏúÑÏπò Ï†ïÎ†¨", "ÏùòÏûê ÏúÑ Î¨ºÍ±¥ Ï†ïÎ¶¨"],
        Í∞ÄÎ∞©: ["ÎÇ¥Ïö©Î¨º ÎπÑÏö∞Í∏∞", "Ï†úÏûêÎ¶¨Ïóê Í±∏Í∏∞/ÎëêÍ∏∞"],
        Ìú¥ÎåÄÌè∞: ["Ï∂©Ï†Ñ ÏúÑÏπòÏóê ÎëêÍ∏∞", "Í±∞ÏπòÎåÄÏóê ÎÜìÍ∏∞"],
        Î¶¨Î™®Ïª®: ["Ï†úÏûêÎ¶¨Î°ú ÏòÆÍ∏∞Í∏∞"],
        ÌÇ§Î≥¥Îìú: ["Ï†ïÎ¶¨ ÌõÑ Ï†úÏûêÎ¶¨Ïóê ÎÜìÍ∏∞"],
        ÎßàÏö∞Ïä§: ["Ï†ïÎ¶¨ ÌõÑ Ï†úÏûêÎ¶¨Ïóê ÎÜìÍ∏∞"],
        Ïπ´ÏÜî: ["Ïπ´ÏÜîÍΩÇÏù¥Ïóê Î≥¥Í¥ÄÌïòÍ∏∞"],
        // TODO: Ï£ºÏù∏ÎãòÏùò Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ Í∞êÏßÄÌïòÎäî ÏÉàÎ°úÏö¥ Î¨ºÍ±¥Ïóê ÎåÄÌïú Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
        // Ïòà: 'ÌôîÏû•Ìíà': ["ÌôîÏû•ÎåÄÏóê Ï†ïÎèàÌïòÍ∏∞", "ÏÇ¨Ïö©Í∏∞Ìïú ÌôïÏù∏"],
        // Ïòà: 'Ï≤≠ÏÜåÏö©Ìíà': ["Ï†ïÌï¥ÏßÑ ÏàòÎÇ©Í≥µÍ∞ÑÏóê Î≥¥Í¥Ä", "ÏÑ∏Ï†ú Ïö©Í∏∞ Ï†ïÎ¶¨"]
    };

    // Í≥µÍ∞Ñ Ï∂îÎ°†ÏùÑ ÏúÑÌïú ÌÇ§ÏõåÎìú Í∑∏Î£π (COCO ÌÅ¥ÎûòÏä§ Í∏∞Ï§ÄÏúºÎ°ú ÌôïÏû• ÌïÑÏöî)
    const spaceGroups = {
        'Ï±ÖÏÉÅ Ï£ºÎ≥Ä': ["Ï±Ö", "ÎÖ∏Ìä∏Î∂Å", "ÎßàÏö∞Ïä§", "ÌÇ§Î≥¥Îìú", "Ïªµ", "ÏùòÏûê"],
        'Ïπ®Ïã§': ["Ïπ®ÎåÄ", "Î≤†Í∞ú", "Ïù¥Î∂à", "Ï±Ö"], // Ïù¥Î∂à, Î≤†Í∞úÎäî COCOÏóê ÏóÜÏßÄÎßå ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú Ìè¨Ìï®Îê† Ïàò ÏûàÎäî Ìï≠Î™©
        'Ï£ºÎ∞©': ["Ïªµ", "Î≥ë", "Í∑∏Î¶á", "ÎÉâÏû•Í≥†", "Ï†ÑÏûêÎ†àÏù∏ÏßÄ"], // 'bowl', 'microwave', 'oven' Îì±
        'Í±∞Ïã§': ["ÏÜåÌåå", "TV", "ÌôîÎ∂Ñ", "ÏùòÏûê", "Î¶¨Î™®Ïª®"],
        'ÏöïÏã§': ["Î≥ÄÍ∏∞", "Ïπ´ÏÜî"],
        // TODO: Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ Í∞êÏßÄÌïòÎäî Í∞ùÏ≤¥Î•º ÌôúÏö©ÌïòÏó¨ Í≥µÍ∞Ñ Í∑∏Î£πÏùÑ ÌôïÏû•ÌïòÏÑ∏Ïöî.
        // Ïòà: 'ÏöïÏã§': ["Î≥ÄÍ∏∞", "Ïπ´ÏÜî", "ÌôîÏû•Ìíà"],
        // Ïòà: 'Ï≤≠ÏÜåÏö©Ìíà Î≥¥Í¥ÄÌï®': ["Ï≤≠ÏÜåÏö©Ìíà", "Î∞îÍµ¨Îãà"]
    };

    // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú ÌôîÎ©¥ÏùÑ Î≥ÄÍ≤ΩÌïòÎäî Ìï®Ïàò
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    // Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
    function openResultModal(title, spaceInfo, tipsInfo, scoreInfo, checklistInfo, feedbackMessage, showResetBtn = false) {
        modalTitle.textContent = title;
        modalSpaceInfo.innerHTML = `<h3>üè† ÏòàÏÉÅ Í≥µÍ∞Ñ</h3><p>${spaceInfo}</p>`;
        modalTipsInfo.innerHTML = `<h3>üí° Ï†ïÎ¶¨ ÌåÅ</h3><p>${tipsInfo}</p>`;
        modalScoreInfo.innerHTML = scoreInfo ? `<h3>‚ú® Ï†ïÎ¶¨ Ï†êÏàò</h3><p>${scoreInfo}</p>` : '';
        modalChecklistInfo.innerHTML = checklistInfo ? `<h3>‚úîÔ∏è Ï†ïÎ¶¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</h3>${checklistInfo}` : '';
        modalFeedbackMessage.textContent = feedbackMessage;
        resetAppBtn.style.display = showResetBtn ? 'block' : 'none'; // Îã§Ïãú ÏãúÏûë Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä

        resultModalOverlay.style.display = 'flex'; // flexÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ Ïú†ÏßÄ
    }

    function closeResultModal() {
        resultModalOverlay.style.display = 'none';
        // 'Ï†ïÎ¶¨ ÌõÑ Ï†êÏàò Îß§Í∏∞Í∏∞'Í∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå 'Ï†ïÎ¶¨ ÌõÑ' Î≤ÑÌäºÏùÑ ÌôúÏÑ±Ìôî (Îã§Ïãú ÏãúÏûë Î≤ÑÌäºÏù¥ ÏóÜÏúºÎ©¥)
        if (resetAppBtn.style.display === 'none') {
             // Ïù¥ Î∂ÄÎ∂ÑÏùÄ analyzeSnapshot Ìï®ÏàòÏóêÏÑú ÏÉÅÌÉúÏóê Îî∞Îùº Ï†úÏñ¥ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Îî±Ìûà Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.
        }
    }

    // Ïñ¥Îñ§ Í≥µÍ∞ÑÏù∏ÏßÄ Ï∂îÎ°† (Í∞ÄÏû• ÎßéÏù¥ Í∞êÏßÄÎêú Í∞ùÏ≤¥Í∞Ä ÏÜçÌïú Í∑∏Î£πÏúºÎ°ú ÌåêÎã®)
    function guessSpace(labels) {
        const counts = {};
        for (const key in spaceGroups) {
            counts[key] = labels.filter(l => spaceGroups[key].includes(l)).length;
        }
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
        if (sorted.length > 0 && sorted[0][1] > 0 && sorted[0][1] >= 2) { // ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅ Í∞êÏßÄÎê† ÎïåÎßå Ïú†Ìö®
            return sorted[0][0];
        }
        return "Ïïå Ïàò ÏóÜÎäî Í≥µÍ∞Ñ";
    }

    function generateTips(labels) {
        const uniqueFriendlyLabels = [...new Set(labels.map(mapLabelToFriendlyName))];
        const tips = uniqueFriendlyLabels.map(l => tipDictionary[l]).filter(Boolean);
        return tips.length ? tips.join(" ") : "üëç ÌòÑÏû¨ ÌäπÎ≥ÑÌûà Ï†ïÎ¶¨Ìï† Î¨ºÍ±¥Ïù¥ Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!";
    }

    function calculateScore(before, after) {
        let score = 50; // Í∏∞Î≥∏ Ï†êÏàò
        let feedback = "";

        const beforeSet = new Set(before);
        const afterCounts = {};
        after.forEach(item => { afterCounts[item] = (afterCounts[item] || 0) + 1; });

        let removedCount = 0;
        let addedCount = 0;
        let improvedMessyScore = 0;

        // ÌäπÏ†ï 'Ïñ¥ÏßÄÎüΩÌûò' Í∞ùÏ≤¥ Î™©Î°ù (COCO-SSD Î∞è Ïª§Ïä§ÌÖÄ Î™®Îç∏ Î†àÏù¥Î∏î Ìè¨Ìï® Í∞ÄÎä•)
        // customLabelsÏóê ÏûàÎäî Î™®Îì† Í∞ùÏ≤¥Îäî 'Ïñ¥ÏßÄÎüΩÌûò' Í∞ùÏ≤¥Î°ú Í∞ÑÏ£ºÎê† Ïàò ÏûàÏäµÎãàÎã§.
        const messyObjects = ['Ïªµ', 'Ï±Ö', 'Î≥ë', 'Í∞ÄÎ∞©', 'Ìú¥ÎåÄÌè∞', 'Î¶¨Î™®Ïª®', 'ÌÇ§Î≥¥Îìú', 'ÎßàÏö∞Ïä§', 'Ïπ´ÏÜî', ...customLabels]; 

        const beforeCounts = {};
        before.forEach(item => { beforeCounts[item] = (beforeCounts[item] || 0) + 1; });

        // ÏÇ¨ÎùºÏßÑ Í∞ùÏ≤¥ Î∞è Í∞êÏÜåÌïú Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ ÌôïÏù∏
        beforeSet.forEach(item => {
            const beforeQty = beforeCounts[item] || 0;
            const afterQty = afterCounts[item] || 0;

            if (beforeQty > afterQty) {
                removedCount += (beforeQty - afterQty);
                if (messyObjects.includes(item)) {
                    improvedMessyScore += (beforeQty - afterQty) * 10; // Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ Í∞êÏÜå Ïãú Í∞ÄÏ§ëÏπò
                }
            }
        });

        // Ï∂îÍ∞ÄÎêú Í∞ùÏ≤¥ ÌôïÏù∏
        after.forEach(item => {
            const beforeQty = beforeCounts[item] || 0;
            const afterQty = afterCounts[item] || 0;
            if (afterQty > beforeQty) {
                addedCount += (afterQty - beforeQty);
            }
        });

        score += removedCount * 5; // ÏÇ¨ÎùºÏßÑ Í∞ùÏ≤¥Îãπ Ï†êÏàò
        score += improvedMessyScore; // Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ Í∞êÏÜåÎ°ú Ïù∏Ìïú Ï∂îÍ∞Ä Ï†êÏàò
        score -= addedCount * 3; // ÏÉàÎ°úÏö¥ Í∞ùÏ≤¥Í∞Ä ÏÉùÍ∏∞Î©¥ Í∞êÏ†ê (ÏÉàÎ°úÏö¥ Ïì∞Î†àÍ∏∞ Îì±)

        if (score > 100) score = 100;
        if (score < 0) score = 0;

        if (score >= 90) feedback = "Ï†ïÎßê Íπ®ÎÅóÌïòÍ≤å Ï†ïÎ¶¨ÌñàÏñ¥Ïöî! ÌõåÎ•≠Ìï©ÎãàÎã§! üéâ";
        else if (score >= 70) feedback = "ÏïÑÏ£º Ïûò Ï†ïÎ¶¨ÌñàÏñ¥Ïöî! Îã§ÏùåÏóî Îçî ÏôÑÎ≤ΩÌïòÍ≤å! üëç";
        else if (score >= 50) feedback = "ÍΩ§ Í¥úÏ∞ÆÍ≤å Ï†ïÎ¶¨ÌñàÎÑ§Ïöî. Ï°∞Í∏àÎßå Îçî ÎÖ∏Î†•ÌïòÎ©¥ ÏôÑÎ≤ΩÌï¥Ï†∏Ïöî! üòâ";
        else feedback = "Ï°∞Í∏à Îçî Ï†ïÎ¶¨Ìï¥Ïïº Ìï† Í≤É Í∞ôÏïÑÏöî. Îã§Ïùå Î≤àÏóêÎäî Îçî ÏûòÌï† Ïàò ÏûàÏñ¥Ïöî! üí™";

        return { score: `üßπ Ï†ïÎ¶¨ Ï†êÏàò: ${score}Ï†ê (Ï†ïÎ¶¨ Ï†Ñ ${before.length}Í∞ú ‚Üí Ï†ïÎ¶¨ ÌõÑ ${after.length}Í∞ú Í∞êÏßÄ)`, feedback: feedback };
    }

    function generateChecklistHtml(labels) {
        let html = `<h3>‚úîÔ∏è Ï†ïÎ¶¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</h3><ul>`;
        const uniqueFriendlyLabels = [...new Set(labels.map(mapLabelToFriendlyName))];
        let hasTasks = false;

        uniqueFriendlyLabels.forEach(label => {
            const tasks = checklistDictionary[label];
            if (tasks && tasks.length > 0) {
                hasTasks = true;
                html += `<li><strong>${label} Í¥ÄÎ†®:</strong></li>`;
                tasks.forEach(task => {
                    html += `<li><input type="checkbox"> ${task}</li>`;
                });
            }
        });

        if (!hasTasks) {
            html += `<li>ÌòÑÏû¨ Ï†ïÎ¶¨Ìï† Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</li>`;
        }
        html += '</ul>';
        return html;
    }

    // Ï∫îÎ≤ÑÏä§Ïóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
    function drawBoundingBoxes(targetCtx, targetCanvas, results) {
        targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height); // Ïù¥Ï†Ñ Í∑∏Î¶º ÏßÄÏö∞Í∏∞
        // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Îäî Î∂ÄÎ∂ÑÏùÄ Ïä§ÎÉÖÏÉ∑ ÏãúÏóêÎßå! (Î™®Îã¨ÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Î≥¥Ïó¨Ï§Ñ Îïå)

        results.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            targetCtx.strokeStyle = '#00FF00'; // Ï¥àÎ°ùÏÉâ Î∞ïÏä§
            targetCtx.lineWidth = 3;
            targetCtx.strokeRect(x, y, width, height);

            targetCtx.fillStyle = '#00FF00'; // Ï¥àÎ°ùÏÉâ Í∏ÄÏûê Î∞∞Í≤Ω
            targetCtx.font = 'bold 18px Noto Sans KR';
            const friendlyLabel = mapLabelToFriendlyName(prediction.class);
            const text = `${friendlyLabel} (${Math.round(prediction.score * 100)}%)`;
            const textWidth = targetCtx.measureText(text).width;
            
            // ÌÖçÏä§Ìä∏ Î∞∞Í≤ΩÏùÑ Î∞ïÏä§ ÏúÑÏóê Í∑∏Î¶¨Îêò, Ï∫îÎ≤ÑÏä§ ÏÉÅÎã®ÏùÑ Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ï†ï
            const textBgY = y - 20;
            const textY = y - 5;

            if (textBgY < 0) { // ÌÖçÏä§Ìä∏Í∞Ä Ï∫îÎ≤ÑÏä§ ÏÉÅÎã®ÏùÑ Î≤óÏñ¥ÎÇòÎäî Í≤ΩÏö∞
                targetCtx.fillRect(x, y, textWidth + 8, 20); // Î∞ïÏä§ ÏãúÏûëÏ†êÏóê Í∑∏Î¶¨Í∏∞
                targetCtx.fillStyle = '#000000';
                targetCtx.fillText(text, x + 4, y + 15); // Í∏ÄÏûê ÏúÑÏπò Ï°∞Ï†ï
            } else {
                targetCtx.fillRect(x, textBgY, textWidth + 8, 20);
                targetCtx.fillStyle = '#000000';
                targetCtx.fillText(text, x + 4, textY);
            }
        });
    }

    // Ïã§ÏãúÍ∞Ñ ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶ºÏóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
    async function detectLiveObjects() {
        if (!cocoModel || video.paused || video.ended) {
            requestAnimationFrame(detectLiveObjects); // Î™®Îç∏Ïù¥ Î°úÎìúÎê† ÎïåÍπåÏßÄ Ïû¨Í∑Ä Ìò∏Ï∂ú
            return;
        }

        liveCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height); // Ïù¥Ï†Ñ Î∞ïÏä§ ÏßÄÏö∞Í∏∞

        try {
            // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏùÑ TF ÌÖêÏÑúÎ°ú Î≥ÄÌôò
            const tfImage = tf.browser.fromPixels(video);
            // Î™®Îç∏ ÏòàÏ∏° (minScoreÎ•º 0.3ÏúºÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Îçî ÎßéÏùÄ Í∞ùÏ≤¥ Í∞êÏßÄ ÏãúÎèÑ)
            const results = await cocoModel.detect(tfImage, undefined, 0.3);
            tfImage.dispose(); // ÌÖêÏÑú Î©îÎ™®Î¶¨ Ìï¥Ï†ú

            // Ïã§ÏãúÍ∞Ñ Ï∫îÎ≤ÑÏä§Ïóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
            drawBoundingBoxes(liveCtx, liveCanvas, results);
        } catch (e) {
            console.error("Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ Ïò§Î•ò:", e);
            // Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ Ïò§Î•òÎäî ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏßÅÏ†ë ÌëúÏãúÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏùå
        }
        
        // Îã§Ïùå ÌîÑÎ†àÏûÑ ÏöîÏ≤≠
        requestAnimationFrame(detectLiveObjects);
    }

    async function analyzeSnapshot(stage) {
        errorMessage.textContent = "";
        analysisStatusMessage.textContent = "üîç Î∂ÑÏÑù Ï§ë...";
        analyzeBeforeBtn.disabled = true;
        analyzeAfterBtn.disabled = true;

        // Îëê Í∞ÄÏßÄ Î™®Îç∏ Î™®Îëê Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
        if (!cocoModel || !clutterModel) {
            errorMessage.textContent = "‚ùó Î™®Îç∏Ïù¥ ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
            analysisStatusMessage.textContent = "";
            analyzeBeforeBtn.disabled = false;
            return;
        }

        try {
            // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏùÑ Î™®Îã¨ Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶¨Í∏∞ (Ïä§ÎÉÖÏÉ∑)
            modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
            modalCtx.drawImage(video, 0, 0, modalCanvas.width, modalCanvas.height);

            // COCO-SSD Î™®Îç∏ ÏòàÏ∏° (Í∞ùÏ≤¥ Í∞êÏßÄ)
            const tfImageForCoco = tf.browser.fromPixels(modalCanvas);
            const results = await cocoModel.detect(tfImageForCoco, undefined, 0.3);
            tfImageForCoco.dispose(); // Î©îÎ™®Î¶¨ Ìï¥Ï†ú

            const rawLabels = results.map(r => r.class);
            const friendlyLabels = rawLabels.map(mapLabelToFriendlyName);

            // Î™®Îã¨ Ï∫îÎ≤ÑÏä§Ïóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
            drawBoundingBoxes(modalCtx, modalCanvas, results);

            const spaceGuess = guessSpace(friendlyLabels);
            const tips = generateTips(rawLabels); // ÏõêÎ≥∏ rawLabelsÎ°ú ÌåÅ ÏÉùÏÑ±

            // Ïª§Ïä§ÌÖÄ clutterModelÏùÑ ÏÇ¨Ïö©Ìïú 'Ïñ¥ÏàòÏÑ†Ìï®' Î∂ÑÏÑù
            // **Ï£ºÏùò: Ïù¥ Î∂ÄÎ∂ÑÏùÄ Ï£ºÏù∏ÎãòÏùò Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ Ïñ¥Îñ§ Ï¢ÖÎ•òÏùò Ï∂úÎ†•ÏùÑ ÎÇ¥ÎäîÏßÄÏóê Îî∞Îùº Îã¨ÎùºÏßëÎãàÎã§.**
            // ÌòÑÏû¨ ÏΩîÎìúÎäî Î™®Îç∏Ïù¥ Ïù¥ÎØ∏ÏßÄÏóêÏÑú 'Ïñ¥ÏàòÏÑ†Ìï®'ÏùÑ ÎÇòÌÉÄÎÇ¥Îäî ÏûÑÎ≤†Îî© Î≤°ÌÑ∞Î•º Î∞òÌôòÌïúÎã§Í≥† Í∞ÄÏ†ïÌï©ÎãàÎã§.
            // ÎßåÏïΩ Î∂ÑÎ•ò Î™®Îç∏Ïù¥ÎùºÎ©¥ (Ïòà: 'clean', 'messy' ÌÅ¥ÎûòÏä§), Ï∂úÎ†•ÏùÑ Îã§Î•¥Í≤å Ï≤òÎ¶¨Ìï¥Ïïº Ìï©ÎãàÎã§.
            const tfImageForClutter = tf.browser.fromPixels(modalCanvas)
                .resizeBilinear([224, 224]) // Î™®Îç∏ ÏûÖÎ†• ÌÅ¨Í∏∞Ïóê ÎßûÏ∂∞ Ï°∞Ï†ï (Ï£ºÏù∏Îãò Î™®Îç∏Ïù¥ Ïù¥ ÌÅ¨Í∏∞ÎùºÍ≥† Í∞ÄÏ†ï)
                .expandDims(0) // Î∞∞Ïπò Ï∞®Ïõê Ï∂îÍ∞Ä
                .toFloat()
                .div(255.0); // 0-1 Ïä§ÏºÄÏùºÎ°ú Ï†ïÍ∑úÌôî (Î™®Îç∏ ÌïôÏäµ Î∞©ÏãùÏóê Îî∞Îùº Îã§Î¶Ñ)

            const embedding = await clutterModel.executeAsync(tfImageForClutter);
            const vector = embedding.arraySync()[0]; // ÏûÑÎ≤†Îî© Î≤°ÌÑ∞ Ï∂îÏ∂ú
            embedding.dispose(); // ÌÖêÏÑú Î©îÎ™®Î¶¨ Ìï¥Ï†ú
            tfImageForClutter.dispose(); // ÌÖêÏÑú Î©îÎ™®Î¶¨ Ìï¥Ï†ú

            const avg = vector.reduce((a, b) => a + b, 0) / vector.length; // Î≤°ÌÑ∞ ÌèâÍ∑†ÏùÑ Ïù¥Ïö©Ìïú Ïñ¥ÏàòÏÑ†Ìï® ÏßÄÌëú
            let aiMessage = "";
            if (avg < 0.1) aiMessage = "üßº ÏïÑÏ£º Íπ®ÎÅóÌïú ÏÉÅÌÉúÏûÖÎãàÎã§.";
            else if (avg < 0.15) aiMessage = "üßπ Ï†ïÎèàÎêú ÏÉÅÌÉúÏûÖÎãàÎã§.";
            else aiMessage = "‚ùó Ïñ¥ÏàòÏÑ†Ìïú ÏÉÅÌÉúÏûÖÎãàÎã§. Ï†ïÎ¶¨Í∞Ä ÌïÑÏöîÌï¥Ïöî.";
            // **[ÌÅ¥Îü¨ÌÑ∞ Î™®Îç∏ Ï∂úÎ†• Ìï¥ÏÑù Î°úÏßÅ ÎÅù]**

            if (stage === 'before') {
                beforeLabels = friendlyLabels;
                // beforeSnapshotData = modalCtx.getImageData(0, 0, modalCanvas.width, modalCanvas.height); // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Îäî drawBoundingBoxesÍ∞Ä Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶º

                openResultModal(
                    "üìå Ï†ïÎ¶¨ Ï†Ñ Í≥µÍ∞Ñ Î∂ÑÏÑù Í≤∞Í≥º",
                    spaceGuess,
                    tips,
                    '', // Ï†ïÎ¶¨ Ï†ÑÏóêÎäî Ï†êÏàò ÏóÜÏùå
                    generateChecklistHtml(rawLabels),
                    aiMessage // Ï†ïÎ¶¨ Ï†ÑÏóêÎèÑ AI Î©îÏãúÏßÄ ÌëúÏãú
                );
                analyzeAfterBtn.disabled = false; // Ï†ïÎ¶¨ ÌõÑ Î≤ÑÌäº ÌôúÏÑ±Ìôî
                analyzeBeforeBtn.disabled = false; // Îã§Ïãú Î∂ÑÏÑùÌï† Ïàò ÏûàÎèÑÎ°ù ÌôúÏÑ±Ìôî
            } else { // stage === 'after'
                const { score, feedback } = calculateScore(beforeLabels, friendlyLabels);
                
                openResultModal(
                    "‚ú® Ï†ïÎ¶¨ ÌõÑ Ï†êÏàò Í≤∞Í≥º",
                    spaceGuess,
                    tips, // Ï†ïÎ¶¨ ÌõÑÏóêÎèÑ ÌòÑÏû¨ Í∞êÏßÄÎêú Î¨ºÍ±¥ Î∞îÌÉïÏúºÎ°ú ÌåÅ Ï†úÍ≥µ
                    score, // Ï†ïÎ¶¨ ÌõÑÏóêÎäî Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÎåÄÏã† Ï†êÏàòÍ∞Ä Ï§ëÏöî
                    `${feedback} ${aiMessage}`, // ÌîºÎìúÎ∞±Í≥º AI Î©îÏãúÏßÄ Í≤∞Ìï©
                    true // 'Îã§Ïãú ÏãúÏûë' Î≤ÑÌäº ÌëúÏãú
                );
                analyzeBeforeBtn.disabled = true; // Ï†ïÎ¶¨ ÌõÑÏóêÎäî Îã§Ïãú ÏãúÏûë ÎàÑÎ•¥Í∏∞ Ï†ÑÍπåÏßÄ Ïù¥Ï†Ñ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            }
        } catch (e) {
            console.error("Î∂ÑÏÑù Ïò§Î•ò:", e);
            errorMessage.textContent = "‚ùó Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message;
        } finally {
            analysisStatusMessage.textContent = "";
            if (stage === 'before') { // Ï†ïÎ¶¨ Ï†Ñ Î∂ÑÏÑù ÌõÑ
                analyzeBeforeBtn.disabled = false;
                analyzeAfterBtn.disabled = false;
            } else { // Ï†ïÎ¶¨ ÌõÑ Î∂ÑÏÑù ÌõÑ
                // analyzeAfterBtnÏùÄ Î™®Îã¨ Îã´Í∏∞ Ï†ÑÍπåÏßÄ ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉú Ïú†ÏßÄ
                // resetAppBtnÏù¥ ÌôúÏÑ±ÌôîÎêòÎØÄÎ°ú analyzeBeforeBtnÎßå Í¥ÄÎ¶¨
            }
        }
    }

    // Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
    function resetApplication() {
        beforeLabels = [];
        beforeSnapshotData = null;
        analyzeAfterBtn.disabled = true;
        analyzeBeforeBtn.disabled = false;
        resultModalOverlay.style.display = 'none'; // Î™®Îã¨ Îã´Í∏∞
        errorMessage.textContent = "";
        analysisStatusMessage.textContent = "";
        liveCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height); // Ïã§ÏãúÍ∞Ñ Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
        
        // ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶ºÏù¥ Í∫ºÏ°åÎã§Î©¥ Ïû¨ÏãúÏûë (ÏùºÎ∞òÏ†ÅÏúºÎ°úÎäî Í≥ÑÏÜç ÏºúÏ†∏ ÏûàÏùå)
        if (!video.srcObject || !video.srcObject.active) {
            initCameraAndModel(); // Ïπ¥Î©îÎùº Ïû¨ÏãúÏûë
        }
        showScreen('cameraScreen'); // Ïπ¥Î©îÎùº ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
    }

    // Ï¥àÍ∏∞ Ïπ¥Î©îÎùº Î∞è Î™®Îç∏ Î°úÎìú
    async function initCameraAndModel() {
        showScreen('loadingScreen');
        errorMessage.textContent = "";
        analysisStatusMessage.textContent = "";

        try {
            // TensorFlow.js Î∞±ÏóîÎìúÎ•º Î™ÖÏãúÏ†ÅÏúºÎ°ú CPUÎ°ú ÏÑ§Ï†ï (ÏÑ±Îä• ÏµúÏ†ÅÌôîÎ•º ÏúÑÌï¥ webgl ÏÇ¨Ïö© Í≥†Î†§ Í∞ÄÎä•)
            await tf.setBackend('cpu');
            await tf.ready();
            console.log("‚úÖ TensorFlow Î∞±ÏóîÎìú:", tf.getBackend());

            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } });
            video.srcObject = stream;
            await new Promise(res => video.onloadedmetadata = res); // ÎπÑÎîîÏò§ Î°úÎìú ÎåÄÍ∏∞
            
            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶ºÏóê ÎßûÍ≤å Ï°∞Ï†ï
            liveCanvas.width = video.videoWidth;
            liveCanvas.height = video.videoHeight;
            modalCanvas.width = video.videoWidth;
            modalCanvas.height = video.videoHeight;

            // COCO-SSD Î™®Îç∏ Î°úÎìú (mobilenet_v2Îäî Ï†ïÌôïÎèÑ ÎÜíÏùå, lite_mobilenet_v2Îäî Îπ†Î¶Ñ)
            cocoModel = await cocoSsd.load({ base: 'mobilenet_v2' });
            console.log("‚úÖ COCO-SSD Î™®Îç∏ Î°úÎìú ÏôÑÎ£å!");

            // **[ÏàòÏ†ï]** Ï£ºÏù∏ÎãòÏùò Ïª§Ïä§ÌÖÄ Î™®Îç∏ Î°úÎìú Í≤ΩÎ°ú
            // Ïù¥ Í≤ΩÎ°úÎäî 'your-project-folder/models/yolov8n_oiv7_web_model/model.json' ÏûÖÎãàÎã§.
            clutterModel = await tf.loadGraphModel('./project/models/yolov8n_oiv7_web_model/model.json');
            console.log("‚úÖ Ïª§Ïä§ÌÖÄ (Clutter) Î™®Îç∏ Î°úÎìú ÏôÑÎ£å!"); 
            
            // **[ÏàòÏ†ï]** Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïùò label.txt Î°úÎìú Í≤ΩÎ°ú
            customLabels = await loadLabels('./project/models/yolov8n_oiv7_web_model/label.txt');
            console.log("‚úÖ Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏î Î°úÎìú ÏôÑÎ£å:", customLabels);


            showScreen('cameraScreen'); // Ïπ¥Î©îÎùº ÌôîÎ©¥ ÌôúÏÑ±Ìôî
            analyzeBeforeBtn.disabled = false; // Ï†ïÎ¶¨ Ï†Ñ Î∂ÑÏÑù Î≤ÑÌäº ÌôúÏÑ±Ìôî

            // Ïã§ÏãúÍ∞Ñ Í∞ùÏ≤¥ Í∞êÏßÄ ÏãúÏûë
            requestAnimationFrame(detectLiveObjects);

        } catch (e) {
            console.error("Ï¥àÍ∏∞Ìôî Ïò§Î•ò:", e);
            errorMessage.textContent = "‚ùó Ïπ¥Î©îÎùº ÎòêÎäî Î™®Îç∏ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message + ". Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏùÑ ÌôïÏù∏ÌïòÍ≥† Î∏åÎùºÏö∞Ï†ÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ Ï£ºÏÑ∏Ïöî.";
            showScreen('cameraScreen'); // Ïπ¥Î©îÎùº ÌôîÎ©¥Îßå Î≥¥Ïù¥Í≥† Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
            // Ïò§Î•ò Î∞úÏÉù Ïãú Î≤ÑÌäº Î™®Îëê ÎπÑÌôúÏÑ±Ìôî
            analyzeBeforeBtn.disabled = true;
            analyzeAfterBtn.disabled = true;
        }
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    analyzeBeforeBtn.addEventListener('click', () => analyzeSnapshot('before'));
    analyzeAfterBtn.addEventListener('click', () => analyzeSnapshot('after'));

    // Ï¥àÍ∏∞Ìôî Ìï®Ïàò Ìò∏Ï∂ú
    initCameraAndModel();
</script>

</body>
</html>